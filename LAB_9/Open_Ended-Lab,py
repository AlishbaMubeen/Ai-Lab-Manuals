import tensorflow as tf
from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import Conv2D, MaxPooling2D, Flatten, Dense, Dropout
from tensorflow.keras.preprocessing.image import ImageDataGenerator
import matplotlib.pyplot as plt
import numpy as np
import seaborn as sns
from sklearn.metrics import confusion_matrix
import os

# --- 1. Path aur Dataset Setup ---
# Ye line automatically 'dataset' folder ka rasta dhoond legi
current_dir = os.path.dirname(os.path.abspath(__file__))
base_dir = os.path.join(current_dir, 'dataset')

print(f"Checking path: {base_dir}")

# Preprocessing: Images ko resize aur normalize karna
datagen = ImageDataGenerator(rescale=1./255, validation_split=0.2)

train_generator = datagen.flow_from_directory(
    base_dir,
    target_size=(150, 150),
    batch_size=4,
    class_mode='binary',
    subset='training'
)

test_generator = datagen.flow_from_directory(
    base_dir,
    target_size=(150, 150),
    batch_size=4,
    class_mode='binary',
    subset='validation',
    shuffle=False
)

# --- 2. Build CNN Model ---
model = Sequential([
    # Input Layer (150x150 images with 3 color channels)
    Conv2D(32, (3, 3), activation='relu', input_shape=(150, 150, 3)),
    MaxPooling2D(2, 2),
    
    Conv2D(64, (3, 3), activation='relu'),
    MaxPooling2D(2, 2),
    
    Flatten(),
    Dense(64, activation='relu'),
    Dropout(0.5), # Overfitting se bachne ke liye
    Dense(1, activation='sigmoid') # Binary Output (0=Cat, 1=Dog)
])

model.compile(optimizer='adam', loss='binary_crossentropy', metrics=['accuracy'])

# --- 3. Training ---
print("\nTraining shuru ho rahi hai...")
history = model.fit(train_generator, epochs=15, validation_data=test_generator)

# --- 4. Accuracy aur Loss Graphs ---

plt.figure(figsize=(12, 5))
plt.subplot(1, 2, 1)
plt.plot(history.history['accuracy'], label='Train Accuracy')
plt.plot(history.history['val_accuracy'], label='Test Accuracy')
plt.title('Model Accuracy')
plt.legend()

plt.subplot(1, 2, 2)
plt.plot(history.history['loss'], label='Train Loss')
plt.plot(history.history['val_loss'], label='Test Loss')
plt.title('Model Loss')
plt.legend()
plt.show()

# --- 5. Confusion Matrix ---
test_generator.reset()
Y_pred = model.predict(test_generator)
y_pred = (Y_pred > 0.5).astype(int)

cm = confusion_matrix(test_generator.classes, y_pred)
plt.figure(figsize=(6, 5))
sns.heatmap(cm, annot=True, fmt='d', xticklabels=['Cat', 'Dog'], yticklabels=['Cat', 'Dog'], cmap='Blues')
plt.xlabel('Predicted')
plt.ylabel('Actual')
plt.title('Confusion Matrix')
plt.show()

# --- 6. Prediction for Test Image ---
def predict_result(img_path):
    img = tf.keras.utils.load_img(img_path, target_size=(150, 150))
    x = tf.keras.utils.img_to_array(img) / 255.0
    x = np.expand_dims(x, axis=0)
    
    prediction = model.predict(x)
    if prediction[0] > 0.5:
        print("\n" + "="*30)
        print("RESULT: This image is a DOG")
        print("="*30)
    else:
        print("\n" + "="*30)
        print("RESULT: This image is a CAT")
        print("="*30)

# Folder se pehli cat image utha kar check karna
try:
    first_cat = os.path.join(base_dir, 'cats', os.listdir(os.path.join(base_dir, 'cats'))[0])
    predict_result(first_cat)
except Exception as e:
    print("Prediction fail: Check image path.")
